<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR Grabbing Test - Playground</title>
    <meta name="description" content="VR Playground with Grabbable Objects">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #hud {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 20px;
            text-align: center;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px 30px;
            border-radius: 10px;
        }
        #instructions {
            font-size: 16px;
            margin-top: 10px;
            color: #AAAAAA;
        }
    </style>
</head>
<body>
    <div id="hud">
        <div style="font-size: 28px; font-weight: bold; margin-bottom: 10px;">ðŸŽ® VR Grabbing Playground</div>
        <div id="instructions">
            Move hand near objects | Press GRIP to grab | Release GRIP to drop
        </div>
    </div>

    <a-scene>
        <!-- Sky -->
        <a-sky color="#87CEEB"></a-sky>

        <!-- Ground -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" color="#7BC8A4" shadow="receive: true"></a-plane>

        <!-- Lighting -->
        <a-light type="ambient" color="#666"></a-light>
        <a-light type="directional" color="#FFF" intensity="0.8" position="-0.5 1 1" shadow="cast: true"></a-light>
        <a-light type="point" intensity="1" position="2 3 4"></a-light>

        <!-- Player Rig with Movement Controls -->
        <a-entity id="player-rig" position="0 0 0" movement-controls="speed: 0.15; fly: false">
            <!-- Camera/Head -->
            <a-camera id="camera" position="0 1.6 0" look-controls>
                <!-- In-VR prompt -->
                <a-text id="vr-prompt" value="" position="0 0.2 -0.6" align="center" color="#FFD700" width="0.5"></a-text>
            </a-camera>
            
            <!-- Player Body -->
            <a-entity id="player-body" position="0 0.9 0">
                <!-- Torso -->
                <a-box id="torso" position="0 0 -0.15" width="0.5" height="0.7" depth="0.25" color="#2C3E50"></a-box>
            </a-entity>

            <!-- LEFT HAND -->
            <a-entity 
                id="leftHand" 
                hand-controls="hand: left; handModelStyle: lowPoly"
                oculus-touch-controls="hand: left"
                vive-controls="hand: left"
                hand-grab-controller="hand: left">
            </a-entity>
            
            <!-- RIGHT HAND -->
            <a-entity 
                id="rightHand" 
                hand-controls="hand: right; handModelStyle: lowPoly"
                oculus-touch-controls="hand: right"
                vive-controls="hand: right"
                hand-grab-controller="hand: right">
            </a-entity>
        </a-entity>

        <!-- Grabbable Blocks on Table -->
        <!-- Red Cube -->
        <a-box class="grabbable" position="-0.5 1.1 -1.5" width="0.15" height="0.15" depth="0.15" color="#FF0000" 
               grabbable proximity-prompt shadow="cast: true">
        </a-box>

        <!-- Green Cube -->
        <a-box class="grabbable" position="-0.2 1.1 -1.5" width="0.15" height="0.15" depth="0.15" color="#00FF00" 
               grabbable proximity-prompt shadow="cast: true">
        </a-box>

        <!-- Blue Cube -->
        <a-box class="grabbable" position="0.1 1.1 -1.5" width="0.15" height="0.15" depth="0.15" color="#0000FF" 
               grabbable proximity-prompt shadow="cast: true">
        </a-box>

        <!-- Yellow Cube -->
        <a-box class="grabbable" position="0.4 1.1 -1.5" width="0.15" height="0.15" depth="0.15" color="#FFFF00" 
               grabbable proximity-prompt shadow="cast: true">
        </a-box>

        <!-- Purple Sphere -->
        <a-sphere class="grabbable" position="-0.3 1.2 -1.2" radius="0.08" color="#FF00FF" 
                  grabbable proximity-prompt shadow="cast: true">
        </a-sphere>

        <!-- Orange Sphere -->
        <a-sphere class="grabbable" position="0.2 1.2 -1.2" radius="0.08" color="#FFA500" 
                  grabbable proximity-prompt shadow="cast: true">
        </a-sphere>

        <!-- Cyan Cylinder -->
        <a-cylinder class="grabbable" position="-0.5 1.15 -1.8" radius="0.06" height="0.2" color="#00FFFF" 
                    grabbable proximity-prompt shadow="cast: true">
        </a-cylinder>

        <!-- Pink Cylinder -->
        <a-cylinder class="grabbable" position="0.3 1.15 -1.8" radius="0.06" height="0.2" color="#FF69B4" 
                    grabbable proximity-prompt shadow="cast: true">
        </a-cylinder>

        <!-- Large Gray Cube (heavy) -->
        <a-box class="grabbable" position="0 1.2 -2" width="0.25" height="0.25" depth="0.25" color="#888888" 
               grabbable proximity-prompt shadow="cast: true">
        </a-box>

        <!-- Table -->
        <a-box position="0 0.95 -1.5" width="1.5" height="0.1" depth="1" color="#8B4513" shadow="receive: true"></a-box>
        <!-- Table Legs -->
        <a-box position="-0.65 0.5 -1.9" width="0.08" height="0.9" depth="0.08" color="#654321"></a-box>
        <a-box position="0.65 0.5 -1.9" width="0.08" height="0.9" depth="0.08" color="#654321"></a-box>
        <a-box position="-0.65 0.5 -1.1" width="0.08" height="0.9" depth="0.08" color="#654321"></a-box>
        <a-box position="0.65 0.5 -1.1" width="0.08" height="0.9" depth="0.08" color="#654321"></a-box>

        <!-- Wall with Target Area -->
        <a-box position="0 1.5 -3" width="4" height="3" depth="0.1" color="#D2691E"></a-box>
        <a-text value="THROW OBJECTS HERE!" position="0 2 -2.95" align="center" color="#FFF" width="3"></a-text>
        
        <!-- Target circles on wall -->
        <a-ring position="0 1.5 -2.95" radius-inner="0.15" radius-outer="0.2" color="#FF0000"></a-ring>
        <a-ring position="0 1.5 -2.95" radius-inner="0.25" radius-outer="0.3" color="#FFFF00"></a-ring>
        <a-ring position="0 1.5 -2.95" radius-inner="0.35" radius-outer="0.4" color="#00FF00"></a-ring>

        <!-- Decorative objects -->
        <a-cylinder position="-2 0.5 -2" radius="0.3" height="1" color="#654321"></a-cylinder>
        <a-cone position="-2 1.2 -2" radius-bottom="0.5" radius-top="0.05" height="0.8" color="#228B22"></a-cone>
        
        <a-cylinder position="2 0.5 -2" radius="0.3" height="1" color="#654321"></a-cylinder>
        <a-cone position="2 1.2 -2" radius-bottom="0.5" radius-top="0.05" height="0.8" color="#228B22"></a-cone>

        <!-- Floor markers to show play area -->
        <a-circle position="0 0.01 0" radius="0.3" rotation="-90 0 0" color="#FFFFFF" opacity="0.5"></a-circle>
        <a-text value="START HERE" position="0 0.01 0.5" rotation="-90 0 0" align="center" color="#000" width="2"></a-text>
    </a-scene>

    <script>
        // Grabbable object component
        AFRAME.registerComponent('grabbable', {
            init: function() {
                this.grabbed = false;
                this.grabber = null;
                this.originalParent = this.el.parentNode;
                this.velocity = new THREE.Vector3();
                this.previousPosition = new THREE.Vector3();
            }
        });

        // Proximity prompt component
        AFRAME.registerComponent('proximity-prompt', {
            schema: {
                distance: {type: 'number', default: 0.25}
            },
            init: function() {
                this.checkProximity = this.checkProximity.bind(this);
            },
            tick: function() {
                this.checkProximity();
            },
            checkProximity: function() {
                if (this.el.components.grabbable.grabbed) return;
                
                const objPos = this.el.object3D.getWorldPosition(new THREE.Vector3());
                const leftHand = document.querySelector('#leftHand');
                const rightHand = document.querySelector('#rightHand');
                const vrPrompt = document.querySelector('#vr-prompt');
                
                let nearHand = false;
                
                // Check left hand
                if (leftHand) {
                    const leftPos = leftHand.object3D.getWorldPosition(new THREE.Vector3());
                    const leftDist = objPos.distanceTo(leftPos);
                    if (leftDist < this.data.distance) {
                        nearHand = true;
                    }
                }
                
                // Check right hand
                if (rightHand) {
                    const rightPos = rightHand.object3D.getWorldPosition(new THREE.Vector3());
                    const rightDist = objPos.distanceTo(rightPos);
                    if (rightDist < this.data.distance) {
                        nearHand = true;
                    }
                }
                
                if (nearHand) {
                    // Show prompt
                    if (vrPrompt) {
                        vrPrompt.setAttribute('value', 'GRIP to Grab');
                        vrPrompt.setAttribute('color', '#00FF00');
                    }
                    
                    // Highlight the object
                    const currentColor = this.el.getAttribute('color');
                    if (!this.el.hasAttribute('data-original-color')) {
                        this.el.setAttribute('data-original-color', currentColor);
                    }
                    
                    // Make it glow
                    this.el.setAttribute('material', 'emissive', currentColor);
                    this.el.setAttribute('material', 'emissiveIntensity', 0.3);
                } else {
                    // Remove highlight
                    this.el.setAttribute('material', 'emissiveIntensity', 0);
                }
            }
        });

        // Hand grab controller
        AFRAME.registerComponent('hand-grab-controller', {
            schema: {
                hand: {type: 'string', default: 'right'}
            },
            init: function() {
                this.grabbedObject = null;
                this.el.addEventListener('gripdown', this.grab.bind(this));
                this.el.addEventListener('gripup', this.release.bind(this));
            },
            grab: function() {
                // Find nearby grabbable objects
                const handPos = this.el.object3D.getWorldPosition(new THREE.Vector3());
                const grabbables = document.querySelectorAll('.grabbable');
                
                let closest = null;
                let closestDist = 0.25; // Grab range
                
                grabbables.forEach(obj => {
                    if (obj.components.grabbable.grabbed) return;
                    
                    const objPos = obj.object3D.getWorldPosition(new THREE.Vector3());
                    const dist = handPos.distanceTo(objPos);
                    
                    if (dist < closestDist) {
                        closest = obj;
                        closestDist = dist;
                    }
                });
                
                if (closest) {
                    // Grab the object
                    this.grabbedObject = closest;
                    closest.components.grabbable.grabbed = true;
                    closest.components.grabbable.grabber = this.el;
                    
                    // Store current position for velocity calculation
                    closest.components.grabbable.previousPosition.copy(
                        closest.object3D.getWorldPosition(new THREE.Vector3())
                    );
                    
                    // Remove physics if any
                    if (closest.hasAttribute('dynamic-body')) {
                        closest.removeAttribute('dynamic-body');
                    }
                    
                    // Attach to hand
                    this.el.appendChild(closest);
                    closest.setAttribute('position', '0 0 -0.15');
                    closest.setAttribute('rotation', '0 0 0');
                    
                    // Remove highlight
                    closest.setAttribute('material', 'emissiveIntensity', 0);
                    
                    // Hide prompt
                    const vrPrompt = document.querySelector('#vr-prompt');
                    if (vrPrompt) vrPrompt.setAttribute('value', '');
                    
                    console.log(this.data.hand + ' hand grabbed object!');
                }
            },
            release: function() {
                if (!this.grabbedObject) return;
                
                const obj = this.grabbedObject;
                
                // Calculate velocity for throwing
                const currentPos = obj.object3D.getWorldPosition(new THREE.Vector3());
                const velocity = new THREE.Vector3().subVectors(
                    currentPos, 
                    obj.components.grabbable.previousPosition
                );
                
                // Detach from hand
                const scene = document.querySelector('a-scene');
                scene.appendChild(obj);
                
                // Set world position
                obj.object3D.position.copy(currentPos);
                
                // Apply throw velocity (simplified physics)
                const throwStrength = 5;
                const throwVelocity = velocity.multiplyScalar(throwStrength);
                
                // Add a simple physics animation
                this.animateThrow(obj, throwVelocity);
                
                // Release
                obj.components.grabbable.grabbed = false;
                obj.components.grabbable.grabber = null;
                
                this.grabbedObject = null;
                
                console.log('Object released with velocity:', throwVelocity);
            },
            animateThrow: function(obj, velocity) {
                const startPos = obj.object3D.position.clone();
                const gravity = -9.8;
                let time = 0;
                const interval = setInterval(() => {
                    time += 0.016; // ~60fps
                    
                    // Physics simulation
                    const newPos = new THREE.Vector3(
                        startPos.x + velocity.x * time,
                        startPos.y + velocity.y * time + 0.5 * gravity * time * time,
                        startPos.z + velocity.z * time
                    );
                    
                    // Stop if hits ground
                    if (newPos.y <= 0.08) {
                        newPos.y = 0.08;
                        clearInterval(interval);
                        
                        // Bounce effect
                        obj.setAttribute('animation', {
                            property: 'position',
                            to: `${newPos.x} ${newPos.y + 0.05} ${newPos.z}`,
                            dur: 100,
                            easing: 'easeOutQuad'
                        });
                        setTimeout(() => {
                            obj.setAttribute('animation', {
                                property: 'position',
                                to: `${newPos.x} ${newPos.y} ${newPos.z}`,
                                dur: 100,
                                easing: 'easeInQuad'
                            });
                        }, 100);
                    }
                    
                    obj.object3D.position.copy(newPos);
                    
                    // Stop after 3 seconds
                    if (time > 3) {
                        clearInterval(interval);
                    }
                }, 16);
            },
            tick: function() {
                // Update previous position for velocity calculation
                if (this.grabbedObject) {
                    const currentPos = this.grabbedObject.object3D.getWorldPosition(new THREE.Vector3());
                    this.grabbedObject.components.grabbable.previousPosition.copy(currentPos);
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('VR Grabbing Playground loaded!');
            console.log('Instructions:');
            console.log('1. Move your hand near any colorful object');
            console.log('2. Press GRIP button to grab it');
            console.log('3. Release GRIP to drop or throw it');
            console.log('4. Try throwing objects at the target on the wall!');
        });
    </script>
</body>
</html>
