<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR Grab Debug - Make Objects VISIBLE!</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <style>
        body { margin: 0; }
        #debug {
            position: fixed; top: 10px; left: 10px;
            color: white; background: rgba(0,0,0,0.8);
            padding: 15px; font-family: monospace; z-index: 9999;
            font-size: 14px; line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="debug">
        <div>Status: Ready</div>
        <div id="leftStatus">Left Hand: Empty</div>
        <div id="rightStatus">Right Hand: Empty</div>
        <div id="positions">Positions: -</div>
    </div>

    <a-scene physics="debug: true; gravity: -9.8">
        <a-sky color="#87CEEB"></a-sky>
        <a-plane position="0 0 0" rotation="-90 0 0" width="50" height="50" color="#7BC8A4" static-body></a-plane>

        <a-light type="ambient" color="#FFF" intensity="1"></a-light>
        <a-light type="directional" intensity="1" position="2 4 2"></a-light>

        <!-- Player -->
        <a-entity id="rig" position="0 0 0" movement-controls="speed: 0.3">
            <a-camera position="0 1.6 0" look-controls></a-camera>

            <!-- LEFT HAND - Visual debug sphere -->
            <a-entity id="leftHand"
                hand-controls="hand: left; handModelStyle: lowPoly"
                oculus-touch-controls="hand: left"
                grab-hand="hand: left">
                <!-- Debug marker -->
                <a-sphere radius="0.05" color="#00FF00" opacity="0.5"></a-sphere>
            </a-entity>

            <!-- RIGHT HAND - Visual debug sphere -->
            <a-entity id="rightHand"
                hand-controls="hand: right; handModelStyle: lowPoly"
                oculus-touch-controls="hand: right"
                grab-hand="hand: right">
                <!-- Debug marker -->
                <a-sphere radius="0.05" color="#FF0000" opacity="0.5"></a-sphere>
            </a-entity>
        </a-entity>

        <!-- BIG RED CUBE - Easy to see -->
        <a-box 
            id="cube1"
            class="grabbable" 
            position="0 1.2 -1" 
            width="0.3" height="0.3" depth="0.3" 
            color="#FF0000"
            material="emissive: #FF0000; emissiveIntensity: 0.5"
            dynamic-body="mass: 1">
        </a-box>

        <!-- BIG GREEN SPHERE -->
        <a-sphere 
            id="sphere1"
            class="grabbable" 
            position="0.5 1.2 -1" 
            radius="0.15" 
            color="#00FF00"
            material="emissive: #00FF00; emissiveIntensity: 0.5"
            dynamic-body="mass: 0.5; shape: sphere">
        </a-sphere>

        <!-- BIG BLUE CYLINDER -->
        <a-cylinder 
            id="cyl1"
            class="grabbable" 
            position="-0.5 1.2 -1" 
            radius="0.1" height="0.3" 
            color="#0000FF"
            material="emissive: #0000FF; emissiveIntensity: 0.5"
            dynamic-body="mass: 0.8; shape: cylinder">
        </a-cylinder>

        <!-- Table -->
        <a-box position="0 0.9 -1" width="2" height="0.1" depth="0.8" color="#8B4513" static-body></a-box>
    </a-scene>

    <script>
        let grabbed = { left: null, right: null };

        function updateDebug(hand, msg) {
            const status = document.getElementById(hand + 'Status');
            if (status) status.textContent = hand.charAt(0).toUpperCase() + hand.slice(1) + ' Hand: ' + msg;
        }

        function updatePositions(obj, hand) {
            const pos = obj.getAttribute('position');
            const worldPos = obj.object3D.getWorldPosition(new THREE.Vector3());
            const scale = obj.getAttribute('scale');
            const visible = obj.getAttribute('visible');
            
            document.getElementById('positions').innerHTML = 
                `${hand} object:<br>` +
                `Local: ${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)}<br>` +
                `World: ${worldPos.x.toFixed(2)}, ${worldPos.y.toFixed(2)}, ${worldPos.z.toFixed(2)}<br>` +
                `Scale: ${scale.x}, ${scale.y}, ${scale.z}<br>` +
                `Visible: ${visible !== false}`;
        }

        AFRAME.registerComponent('grab-hand', {
            schema: { hand: {type: 'string'} },
            
            init: function() {
                console.log(this.data.hand + ' hand initialized');
                this.el.addEventListener('gripdown', this.onGripDown.bind(this));
                this.el.addEventListener('gripup', this.onGripUp.bind(this));
            },

            onGripDown: function() {
                const hand = this.data.hand;
                console.log('=== GRIP DOWN:', hand, '===');
                
                // Already holding something?
                if (grabbed[hand]) {
                    console.log('Already holding something');
                    return;
                }

                // Find nearby objects
                const handPos = this.el.object3D.getWorldPosition(new THREE.Vector3());
                console.log('Hand position:', handPos);
                
                const grabbables = document.querySelectorAll('.grabbable');
                console.log('Found', grabbables.length, 'grabbable objects');
                
                let closest = null;
                let minDist = 0.5; // Increased range
                
                grabbables.forEach(obj => {
                    // Skip if already grabbed
                    if (grabbed.left === obj || grabbed.right === obj) {
                        console.log('Skipping', obj.id, '- already grabbed');
                        return;
                    }
                    
                    const objPos = obj.object3D.getWorldPosition(new THREE.Vector3());
                    const dist = handPos.distanceTo(objPos);
                    console.log('Distance to', obj.id, ':', dist.toFixed(3));
                    
                    if (dist < minDist) {
                        closest = obj;
                        minDist = dist;
                    }
                });
                
                if (!closest) {
                    console.log('No object close enough. Closest was', minDist.toFixed(3), 'meters away');
                    updateDebug(hand, 'Nothing in range');
                    return;
                }

                console.log('Grabbing:', closest.id, 'at distance:', minDist.toFixed(3));
                
                // Store original parent
                const originalParent = closest.parentNode;
                console.log('Original parent:', originalParent.tagName);
                
                // Remove physics
                if (closest.hasAttribute('dynamic-body')) {
                    console.log('Removing dynamic-body');
                    closest.removeAttribute('dynamic-body');
                }
                
                // Get world position BEFORE attaching
                const worldPos = new THREE.Vector3();
                const worldRot = new THREE.Quaternion();
                closest.object3D.getWorldPosition(worldPos);
                closest.object3D.getWorldQuaternion(worldRot);
                console.log('World pos before attach:', worldPos);
                
                // Attach to hand
                this.el.appendChild(closest);
                console.log('Attached to hand');
                
                // Set LOCAL position relative to hand
                // Put it WAY out in front
                closest.setAttribute('position', '0 0 -0.5');
                closest.setAttribute('rotation', '0 0 0');
                closest.setAttribute('scale', '1 1 1');
                closest.setAttribute('visible', 'true');
                
                console.log('Set position to: 0 0 -0.5');
                console.log('Set scale to: 1 1 1');
                console.log('Set visible to: true');
                
                // Store reference
                grabbed[hand] = closest;
                
                // Update debug
                updateDebug(hand, 'Holding ' + closest.id);
                updatePositions(closest, hand);
                
                // Log every frame for 2 seconds
                let frameCount = 0;
                const logInterval = setInterval(() => {
                    const pos = closest.getAttribute('position');
                    const wPos = closest.object3D.getWorldPosition(new THREE.Vector3());
                    console.log('Frame', frameCount++, 'Local:', pos.x.toFixed(2), pos.y.toFixed(2), pos.z.toFixed(2), 
                                'World:', wPos.x.toFixed(2), wPos.y.toFixed(2), wPos.z.toFixed(2));
                    
                    if (frameCount > 120) clearInterval(logInterval); // 2 seconds at 60fps
                }, 16);
            },

            onGripUp: function() {
                const hand = this.data.hand;
                const obj = grabbed[hand];
                
                if (!obj) {
                    console.log('Nothing to release');
                    return;
                }
                
                console.log('=== RELEASING:', obj.id, '===');
                
                // Get world position before detaching
                const worldPos = new THREE.Vector3();
                const worldRot = new THREE.Quaternion();
                obj.object3D.getWorldPosition(worldPos);
                obj.object3D.getWorldQuaternion(worldRot);
                console.log('World pos before detach:', worldPos);
                
                // Detach from hand
                const scene = document.querySelector('a-scene');
                scene.appendChild(obj);
                console.log('Detached from hand');
                
                // Set world position
                obj.object3D.position.copy(worldPos);
                obj.object3D.quaternion.copy(worldRot);
                console.log('Restored world position');
                
                // Re-add physics
                let shape = 'box';
                if (obj.tagName === 'A-SPHERE') shape = 'sphere';
                if (obj.tagName === 'A-CYLINDER') shape = 'cylinder';
                
                obj.setAttribute('dynamic-body', {
                    mass: 1,
                    shape: shape
                });
                console.log('Re-added physics with shape:', shape);
                
                grabbed[hand] = null;
                updateDebug(hand, 'Empty');
                
                console.log('Release complete');
            },

            tick: function() {
                const hand = this.data.hand;
                if (grabbed[hand]) {
                    updatePositions(grabbed[hand], hand);
                }
            }
        });

        console.log('%c=== VR GRAB DEBUG MODE ===', 'color: #0F0; font-size: 20px; font-weight: bold');
        console.log('Watch the console for detailed grab/release logs');
        console.log('Green sphere = left hand position');
        console.log('Red sphere = right hand position');
    </script>
</body>
</html>
