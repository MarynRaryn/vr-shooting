<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VR ULTRA SANDBOX: THE REBIRTH</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #vr-hud {
            position: absolute; top: 20px; left: 20px; color: #00ffff; 
            background: rgba(0, 0, 0, 0.9); padding: 15px; border: 2px solid #00ffff;
            border-radius: 10px; pointer-events: none; z-index: 100;
        }
        .stat { font-size: 13px; margin-bottom: 4px; text-transform: uppercase; }
    </style>
</head>
<body>
    <div id="vr-hud">
        <div class="stat">‚óè ENGINE: STABLE CORE LOADED</div>
        <div class="stat">MOVEMENT: LEFT THUMBSTICK (FIXED)</div>
        <div class="stat">GUNS: PISTOL & RIFLE (PULL TRIGGER)</div>
        <div class="stat">RELOAD: GRAB MAG -> TOUCH GUN HANDLE</div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
        import { VRButton } from 'three/addons/webxr/VRButton.js';

        // --- 1. SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        const playerRig = new THREE.Group();
        playerRig.add(camera);
        scene.add(playerRig);

        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(50, 100, 50);
        sun.castShadow = true;
        scene.add(sun, new THREE.AmbientLight(0xffffff, 0.5));

        // --- 2. IMPROVED PHYSICS & WORLD ---
        const physicsItems = [];
        class PhysBody {
            constructor(mesh, type = 'prop') {
                this.mesh = mesh;
                this.type = type;
                this.vel = new THREE.Vector3();
                this.grabbed = false;
                this.ammo = (type === 'pistol' || type === 'rifle') ? 0 : 0;
                this.active = true;
                physicsItems.push(this);
            }
            update(dt) {
                if (!this.active || this.grabbed) return;
                this.vel.y -= 9.8 * dt;
                this.mesh.position.addScaledVector(this.vel, dt);
                if (this.mesh.position.y < 0.1) {
                    this.mesh.position.y = 0.1;
                    this.vel.set(0,0,0);
                }
            }
        }

        const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({ color: 0x3d5a3d }));
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; scene.add(floor);

        // Houses (Restored)
        function makeHouse(x, z, col) {
            for(let y=0; y<6; y++) {
                for(let i=0; i<5; i++) {
                    const b = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.4, 0.4), new THREE.MeshStandardMaterial({color: col}));
                    b.position.set(x + i*0.85, y*0.45 + 0.2, z);
                    scene.add(b); new PhysBody(b, 'brick');
                }
            }
        }
        makeHouse(-10, -10, 0x884444);

        // --- 3. THE ARSENAL (REBUILT) ---
        const belt = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 0.2), new THREE.MeshStandardMaterial({color: 0x00ffff, wireframe: true}));
        scene.add(belt);

        function createWeapon(type, x, z) {
            const g = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, type==='rifle'?0.8:0.4), new THREE.MeshStandardMaterial({color: 0x222}));
            g.add(body);
            const muz = new THREE.Object3D(); muz.position.z = type==='rifle'?-0.45:-0.25; g.add(muz);
            const well = new THREE.Object3D(); well.position.y = -0.1; g.add(well);
            g.position.set(x, 1, z); scene.add(g);
            const po = new PhysBody(g, type); po.muzzle = muz; po.magWell = well;
            return po;
        }
        const p1 = createWeapon('pistol', 1, 1);
        const r1 = createWeapon('rifle', 2, 1);

        // Welding Tool
        const welder = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.1, 0.4), new THREE.MeshStandardMaterial({color: 0x00ffff}));
        welder.position.set(0, 1, 1); scene.add(welder);
        new PhysBody(welder, 'welder');

        // Dummy
        const dummy = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshStandardMaterial({color: 0xff0000}));
        dummy.position.set(0, 1, -5); scene.add(dummy);
        new PhysBody(dummy, 'dummy');

        // --- 4. CONTROLS & MOVEMENT (FIXED) ---
        const factory = new XRControllerModelFactory();
        const controllers = [];

        function onSqueezeStart(e) {
            const c = e.target;
            const p = new THREE.Vector3().setFromMatrixPosition(c.matrixWorld);
            
            // Belt Mag Spawning
            if(p.distanceTo(belt.position) < 0.35) {
                const mag = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.15, 0.06), new THREE.MeshStandardMaterial({color: 0xffaa00}));
                scene.add(mag); const po = new PhysBody(mag, 'mag'); po.isFull = true;
                c.attach(mag); c.userData.held = po; po.grabbed = true; return;
            }

            physicsItems.forEach(o => {
                if(p.distanceTo(o.mesh.getWorldPosition(new THREE.Vector3())) < 0.4) {
                    o.grabbed = true; c.attach(o.mesh); c.userData.held = o;
                }
            });
        }

        function onSqueezeEnd(e) {
            const c = e.target;
            if(c.userData.held) {
                const h = c.userData.held; scene.attach(h.mesh); h.grabbed = false;
                h.vel.set(0,0,0); // Reset velocity to prevent crazy flying
                c.userData.held = null;
            }
        }

        function onSelectStart(e) {
            const c = e.target; const h = c.userData.held;
            if(h && (h.type==='pistol' || h.type==='rifle') && h.ammo > 0) {
                const b = new THREE.Mesh(new THREE.SphereGeometry(0.04), new THREE.MeshBasicMaterial({color: 0xffff00}));
                b.position.copy(h.muzzle.getWorldPosition(new THREE.Vector3()));
                scene.add(b); const bp = new PhysBody(b, 'bullet');
                bp.vel.set(0, 0, -1).applyQuaternion(h.muzzle.getWorldQuaternion(new THREE.Quaternion())).multiplyScalar(150);
                h.ammo--;
            }
        }

        // Logic for "B" button / Thumbstick click to drop mag
        function ejectMag(c) {
            const h = c.userData.held;
            if(h && (h.type==='pistol' || h.type==='rifle') && h.ammo > 0) {
                h.ammo = 0;
                const dead = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.15, 0.06), new THREE.MeshStandardMaterial({color: 0x000000}));
                dead.position.copy(h.magWell.getWorldPosition(new THREE.Vector3()));
                scene.add(dead); new PhysBody(dead, 'mag');
            }
        }

        for(let i=0; i<2; i++) {
            const c = renderer.xr.getController(i);
            c.addEventListener('squeezestart', onSqueezeStart);
            c.addEventListener('squeezeend', onSqueezeEnd);
            c.addEventListener('selectstart', onSelectStart);
            playerRig.add(c); controllers.push(c);
            const g = renderer.xr.getControllerGrip(i);
            g.add(factory.createControllerModel(g)); playerRig.add(g);
        }

        // --- 5. MAIN ENGINE LOOP ---
        const clock = new THREE.Clock();
        renderer.setAnimationLoop(() => {
            const dt = Math.min(clock.getDelta(), 0.1);
            
            // MOVEMENT (RE-CODED FROM SCRATCH)
            const session = renderer.xr.getSession();
            if(session) {
                session.inputSources.forEach(s => {
                    if(s.gamepad && s.handedness === 'left') {
                        const axes = s.gamepad.axes; // [0:x, 1:y, 2:thumbX, 3:thumbY]
                        const speed = 4 * dt;
                        const rot = camera.rotation.y;
                        playerRig.position.x += (axes[2] * Math.cos(rot) + axes[3] * Math.sin(rot)) * speed;
                        playerRig.position.z += (axes[3] * Math.cos(rot) - axes[2] * Math.sin(rot)) * speed;
                    }
                    if(s.gamepad && s.handedness === 'right' && Math.abs(s.gamepad.axes[2]) > 0.5) {
                        playerRig.rotation.y -= Math.sign(s.gamepad.axes[2]) * 0.05;
                    }
                    // Button check for Eject
                    if(s.gamepad.buttons[4].pressed || s.gamepad.buttons[5].pressed) {
                        ejectMag(s.handedness === 'left' ? controllers[0] : controllers[1]);
                    }
                });
            }

            // Sync Belt
            const cp = new THREE.Vector3(); camera.getWorldPosition(cp);
            belt.position.set(cp.x, cp.y - 0.8, cp.z);
            belt.rotation.y = camera.rotation.y;

            physicsItems.forEach(o => {
                o.update(dt);
                
                // Bullet Collision
                if(o.type === 'bullet') {
                    physicsItems.forEach(t => {
                        if((t.type==='brick' || t.type==='dummy') && o.mesh.position.distanceTo(t.mesh.position) < 0.6) {
                            t.vel.add(o.vel.clone().multiplyScalar(0.05));
                            scene.remove(o.mesh); o.active = false;
                        }
                    });
                }

                // Snap Reload
                if(o.type === 'mag' && o.isFull && o.grabbed) {
                    physicsItems.forEach(gun => {
                        if((gun.type==='pistol' || gun.type==='rifle') && gun.ammo === 0) {
                            if(o.mesh.position.distanceTo(gun.magWell.getWorldPosition(new THREE.Vector3())) < 0.2) {
                                gun.ammo = 30; scene.remove(o.mesh); o.active = false;
                            }
                        }
                    });
                }
            });

            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
