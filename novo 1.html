<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>VR Playground - Grab Everything!</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #hud {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            color: white; font-size: 24px; text-align: center; z-index: 1000;
            background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 10px;
        }
        #ammo { color: #FFD700; font-size: 28px; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="hud">
        <div style="font-size: 32px; font-weight: bold;">ðŸŽ® VR Playground</div>
        <div id="ammo">Ammo: 12/12</div>
        <div style="font-size: 16px; margin-top: 10px; color: #AAA;">GRIP to grab | TRIGGER to shoot (with gun)</div>
    </div>

    <a-scene physics="gravity: -9.8">
        <a-sky color="#87CEEB"></a-sky>
        <a-plane position="0 0 0" rotation="-90 0 0" width="50" height="50" color="#7BC8A4" static-body></a-plane>

        <a-light type="ambient" color="#888"></a-light>
        <a-light type="directional" intensity="0.8" position="-1 2 1"></a-light>

        <!-- Player -->
        <a-entity id="rig" position="0 0 0" movement-controls="speed: 0.2">
            <a-camera position="0 1.6 0" look-controls>
                <a-text id="vr-ammo" value="12/12" position="0 -0.25 -0.7" align="center" color="#FFD700" width="0.6"></a-text>
            </a-camera>

            <!-- LEFT HAND -->
            <a-entity 
                id="leftHand"
                hand-controls="hand: left; handModelStyle: lowPoly"
                oculus-touch-controls="hand: left"
                grab-system="hand: left">
            </a-entity>

            <!-- RIGHT HAND -->
            <a-entity 
                id="rightHand"
                hand-controls="hand: right; handModelStyle: lowPoly"
                oculus-touch-controls="hand: right"
                grab-system="hand: right"
                shoot-system>
            </a-entity>
        </a-entity>

        <!-- WEAPONS TABLE -->
        <a-box position="0 0.5 -1.5" width="2" height="1" depth="0.8" color="#8B4513" static-body></a-box>
        
        <!-- SWORD (Red) -->
        <a-entity class="grabbable" position="-0.6 1.05 -1.5" rotation="0 0 90">
            <a-box width="0.05" height="0.6" depth="0.02" color="#FF0000"></a-box>
            <a-box position="0 -0.25 0" width="0.15" height="0.05" depth="0.02" color="#8B4513"></a-box>
        </a-entity>

        <!-- CROWBAR (Gray) -->
        <a-entity class="grabbable" position="-0.2 1.05 -1.5" rotation="0 0 45">
            <a-cylinder radius="0.02" height="0.7" color="#666666"></a-cylinder>
            <a-box position="0 0.3 0" width="0.15" height="0.02" depth="0.02" color="#666666"></a-box>
        </a-entity>

        <!-- GUN (Black) -->
        <a-entity id="gun" class="grabbable" position="0.2 1.05 -1.5">
            <a-box width="0.08" height="0.12" depth="0.25" color="#1a1a1a"></a-box>
            <a-cylinder position="0 0.02 -0.2" rotation="90 0 0" radius="0.015" height="0.2" color="#333"></a-cylinder>
            <a-box position="0 -0.08 0.03" width="0.06" height="0.12" depth="0.08" color="#222"></a-box>
            <a-sphere id="muzzle-flash" position="0 0.02 -0.3" radius="0.05" color="#FFFF00" visible="false"></a-sphere>
        </a-entity>

        <!-- BLOCKS TABLE -->
        <a-box position="2.5 0.5 -1.5" width="1.5" height="1" depth="0.8" color="#A0522D" static-body></a-box>
        
        <!-- Red Cube -->
        <a-box class="grabbable" position="2.2 1.1 -1.5" width="0.2" height="0.2" depth="0.2" color="#FF0000" dynamic-body="mass: 1"></a-box>
        
        <!-- Green Cube -->
        <a-box class="grabbable" position="2.5 1.1 -1.5" width="0.2" height="0.2" depth="0.2" color="#00FF00" dynamic-body="mass: 1"></a-box>
        
        <!-- Blue Cube -->
        <a-box class="grabbable" position="2.8 1.1 -1.5" width="0.2" height="0.2" depth="0.2" color="#0000FF" dynamic-body="mass: 1"></a-box>

        <!-- Yellow Sphere -->
        <a-sphere class="grabbable" position="2.35 1.2 -1.3" radius="0.1" color="#FFFF00" dynamic-body="mass: 0.5; shape: sphere"></a-sphere>

        <!-- Pink Sphere -->
        <a-sphere class="grabbable" position="2.65 1.2 -1.3" radius="0.1" color="#FF69B4" dynamic-body="mass: 0.5; shape: sphere"></a-sphere>

        <!-- MAGAZINE on floor (respawns) -->
        <a-entity id="magazine1" class="grabbable magazine" position="-0.5 0.1 -0.5">
            <a-box width="0.04" height="0.12" depth="0.06" color="#FFA500"></a-box>
        </a-entity>

        <!-- Target Wall -->
        <a-box position="0 2 -4" width="6" height="4" depth="0.1" color="#654321" static-body></a-box>
        <a-text value="ðŸŽ¯ SHOOT HERE!" position="0 3.5 -3.95" align="center" color="#FFF" width="4"></a-text>

        <!-- Targets -->
        <a-sphere class="target" position="-1.5 2 -3.95" radius="0.3" color="#FF0000"></a-sphere>
        <a-sphere class="target" position="0 2 -3.95" radius="0.3" color="#FFFF00"></a-sphere>
        <a-sphere class="target" position="1.5 2 -3.95" radius="0.3" color="#00FF00"></a-sphere>
    </a-scene>

    <script>
        let currentAmmo = 12;
        let maxAmmo = 12;
        let heldObjects = { left: null, right: null };

        // GRAB SYSTEM
        AFRAME.registerComponent('grab-system', {
            schema: { hand: {type: 'string'} },
            init: function() {
                this.el.addEventListener('gripdown', this.onGrip.bind(this));
                this.el.addEventListener('gripup', this.onRelease.bind(this));
            },
            onGrip: function() {
                const hand = this.data.hand;
                
                // Find closest grabbable object
                const handPos = this.el.object3D.getWorldPosition(new THREE.Vector3());
                const grabbables = document.querySelectorAll('.grabbable');
                
                let closest = null;
                let minDist = 0.3;
                
                grabbables.forEach(obj => {
                    // Skip if already grabbed
                    if (heldObjects.left === obj || heldObjects.right === obj) return;
                    
                    const objPos = obj.object3D.getWorldPosition(new THREE.Vector3());
                    const dist = handPos.distanceTo(objPos);
                    
                    if (dist < minDist) {
                        closest = obj;
                        minDist = dist;
                    }
                });
                
                if (closest) {
                    // Remove physics
                    if (closest.hasAttribute('dynamic-body')) {
                        closest.removeAttribute('dynamic-body');
                    }
                    
                    // Attach to hand
                    this.el.appendChild(closest);
                    
                    // Position in hand based on object type
                    if (closest.id === 'gun') {
                        closest.setAttribute('position', '0 0 -0.15');
                        closest.setAttribute('rotation', '-45 0 0');
                    } else if (closest.classList.contains('magazine')) {
                        closest.setAttribute('position', '0 0 -0.12');
                        closest.setAttribute('rotation', '0 0 0');
                    } else {
                        // Sword, crowbar, blocks
                        closest.setAttribute('position', '0 -0.05 -0.15');
                        closest.setAttribute('rotation', '0 0 0');
                    }
                    
                    closest.setAttribute('scale', '1 1 1');
                    
                    heldObjects[hand] = closest;
                    console.log(hand + ' grabbed:', closest.id || closest.className);
                }
            },
            onRelease: function() {
                const hand = this.data.hand;
                const obj = heldObjects[hand];
                
                if (!obj) return;
                
                // Check magazine reload
                if (obj.classList.contains('magazine')) {
                    const gun = document.querySelector('#gun');
                    if (gun && (heldObjects.left === gun || heldObjects.right === gun)) {
                        // Reload!
                        currentAmmo = maxAmmo;
                        updateAmmo();
                        
                        // Remove magazine
                        obj.parentNode.removeChild(obj);
                        
                        // Spawn new magazine
                        setTimeout(() => {
                            const newMag = document.createElement('a-entity');
                            newMag.classList.add('grabbable', 'magazine');
                            newMag.setAttribute('position', `${-0.5 + Math.random() * 0.3} 0.1 ${-0.5 + Math.random() * 0.3}`);
                            newMag.innerHTML = '<a-box width="0.04" height="0.12" depth="0.06" color="#FFA500"></a-box>';
                            document.querySelector('a-scene').appendChild(newMag);
                        }, 1000);
                        
                        heldObjects[hand] = null;
                        console.log('Reloaded!');
                        return;
                    }
                }
                
                // Get world position
                const worldPos = new THREE.Vector3();
                obj.object3D.getWorldPosition(worldPos);
                
                // Detach from hand
                const scene = document.querySelector('a-scene');
                scene.appendChild(obj);
                obj.object3D.position.copy(worldPos);
                
                // Add physics back
                if (obj.classList.contains('grabbable') && !obj.id) {
                    let shape = 'box';
                    if (obj.tagName === 'A-SPHERE') shape = 'sphere';
                    obj.setAttribute('dynamic-body', {mass: 1, shape: shape});
                }
                
                heldObjects[hand] = null;
                console.log(hand + ' released object');
            }
        });

        // SHOOT SYSTEM (right hand only)
        AFRAME.registerComponent('shoot-system', {
            init: function() {
                this.el.addEventListener('triggerdown', this.onTrigger.bind(this));
            },
            onTrigger: function() {
                // Check if holding gun in either hand
                const gun = document.querySelector('#gun');
                if (gun !== heldObjects.left && gun !== heldObjects.right) return;
                
                if (currentAmmo <= 0) {
                    console.log('Out of ammo!');
                    return;
                }
                
                currentAmmo--;
                updateAmmo();
                
                // Muzzle flash
                const flash = gun.querySelector('#muzzle-flash');
                flash.setAttribute('visible', 'true');
                setTimeout(() => flash.setAttribute('visible', 'false'), 50);
                
                // Raycast from gun
                const gunPos = gun.object3D.getWorldPosition(new THREE.Vector3());
                const gunDir = new THREE.Vector3(0, 0, -1);
                gunDir.applyQuaternion(gun.object3D.getWorldQuaternion(new THREE.Quaternion()));
                
                const raycaster = new THREE.Raycaster(gunPos, gunDir, 0, 20);
                
                // Check targets
                document.querySelectorAll('.target').forEach(target => {
                    const intersects = raycaster.intersectObject(target.object3D, true);
                    if (intersects.length > 0) {
                        hitTarget(target);
                    }
                });
                
                console.log('BANG! Ammo:', currentAmmo);
            }
        });

        function hitTarget(target) {
            const origColor = target.getAttribute('color');
            target.setAttribute('color', '#FFFFFF');
            
            target.setAttribute('animation', {
                property: 'scale',
                to: '0.5 0.5 0.5',
                dur: 200
            });
            
            setTimeout(() => {
                target.setAttribute('color', origColor);
                target.setAttribute('animation', {
                    property: 'scale',
                    to: '1 1 1',
                    dur: 200
                });
            }, 500);
        }

        function updateAmmo() {
            const str = currentAmmo + '/' + maxAmmo;
            document.getElementById('ammo').textContent = 'Ammo: ' + str;
            document.getElementById('vr-ammo').setAttribute('value', str);
            
            if (currentAmmo <= 3) {
                document.getElementById('vr-ammo').setAttribute('color', '#FF0000');
            } else {
                document.getElementById('vr-ammo').setAttribute('color', '#FFD700');
            }
        }

        console.log('VR Playground loaded! Grab objects with GRIP button!');
    </script>
</body>
</html>
